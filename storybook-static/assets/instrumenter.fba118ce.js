import{I as G,J as H,K as V,L as F,M as z,N as X,O as J,w as S,P as Q,j as q,G as D,H as Z,Q as tt,R as et}from"./iframe.b8d81469.js";import"./es.map.constructor.bfc1aa34.js";var nt=G,rt=H;nt("toPrimitive");rt();var it=V,at=F,st=TypeError,ot=function(e){if(it(this),e==="string"||e==="default")e="string";else if(e!=="number")throw st("Incorrect hint");return at(this,e)},ut=z,lt=X,ct=ot,ft=J,j=ft("toPrimitive"),$=Date.prototype;ut($,j)||lt($,j,ct);var m;(function(e){e.DONE="done",e.ERROR="error",e.ACTIVE="active",e.WAITING="waiting"})(m||(m={}));var R;function T(e){return T=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},T(e)}function dt(e,t){if(e==null)return{};var r=vt(e,t),n,u;if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(u=0;u<o.length;u++)n=o[u],!(t.indexOf(n)>=0)&&(!Object.prototype.propertyIsEnumerable.call(e,n)||(r[n]=e[n]))}return r}function vt(e,t){if(e==null)return{};var r={},n=Object.keys(e),u,o;for(o=0;o<n.length;o++)u=n[o],!(t.indexOf(u)>=0)&&(r[u]=e[u]);return r}function yt(e){var t=gt(e,"string");return T(t)==="symbol"?t:String(t)}function gt(e,t){if(T(e)!=="object"||e===null)return e;var r=e[Symbol.toPrimitive];if(r!==void 0){var n=r.call(e,t||"default");if(T(n)!=="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return(t==="string"?String:Number)(e)}function E(e){return pt(e)||_t(e)||K(e)||ht()}function ht(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function _t(e){if(typeof Symbol<"u"&&e[Symbol.iterator]!=null||e["@@iterator"]!=null)return Array.from(e)}function pt(e){if(Array.isArray(e))return P(e)}function N(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function It(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function k(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function mt(e,t,r){return t&&k(e.prototype,t),r&&k(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function M(e,t){return Ot(e)||St(e,t)||K(e,t)||bt()}function bt(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function K(e,t){if(!!e){if(typeof e=="string")return P(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);if(r==="Object"&&e.constructor&&(r=e.constructor.name),r==="Map"||r==="Set")return Array.from(e);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return P(e,t)}}function P(e,t){(t==null||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function St(e,t){var r=e==null?null:typeof Symbol<"u"&&e[Symbol.iterator]||e["@@iterator"];if(r!=null){var n=[],u=!0,o=!1,v,y;try{for(r=r.call(e);!(u=(v=r.next()).done)&&(n.push(v.value),!(t&&n.length===t));u=!0);}catch(d){o=!0,y=d}finally{try{!u&&r.return!=null&&r.return()}finally{if(o)throw y}}return n}}function Ot(e){if(Array.isArray(e))return e}var O={CALL:"instrumenter/call",SYNC:"instrumenter/sync",START:"instrumenter/start",BACK:"instrumenter/back",GOTO:"instrumenter/goto",NEXT:"instrumenter/next",END:"instrumenter/end"},Y=((R=S.FEATURES)===null||R===void 0?void 0:R.interactionsDebugger)!==!0,x={debugger:!Y,start:!1,back:!1,goto:!1,next:!1,end:!1},U=new Error("This function ran after the play function completed. Did you forget to `await` it?"),B=function(t){return Object.prototype.toString.call(t)==="[object Object]"},wt=function(t){return Object.prototype.toString.call(t)==="[object Module]"},Tt=function(t){if(!B(t)&&!wt(t))return!1;if(t.constructor===void 0)return!0;var r=t.constructor.prototype;return!(!B(r)||Object.prototype.hasOwnProperty.call(r,"isPrototypeOf")===!1)},Et=function(t){try{return new t.constructor}catch{return{}}},A=function(){return{renderPhase:void 0,isDebugging:!1,isPlaying:!1,isLocked:!1,cursor:0,calls:[],shadowCalls:[],callRefsByResult:new Map,chainedCallIds:new Set,parentId:void 0,playUntil:void 0,resolvers:{},syncTimeout:void 0,forwardedException:void 0}},L=function(t){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,n=(r?t.shadowCalls:t.calls).filter(function(o){return o.retain});if(!!n.length){var u=new Map(Array.from(t.callRefsByResult.entries()).filter(function(o){var v=M(o,2),y=v[1];return y.retain}));return{cursor:n.length,calls:n,callRefsByResult:u}}},Rt=function(){function e(){var t=this;It(this,e),this.channel=void 0,this.initialized=!1,this.state=void 0,this.channel=q.getChannel(),this.state=S.window.parent.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER_STATE__||{};var r=function(s){var i=s.storyId,l=s.isPlaying,g=l===void 0?!0:l,f=s.isDebugging,a=f===void 0?!1:f,c=t.getState(i);t.setState(i,Object.assign({},A(),L(c,a),{shadowCalls:a?c.shadowCalls:[],chainedCallIds:a?c.chainedCallIds:new Set,playUntil:a?c.playUntil:void 0,isPlaying:g,isDebugging:a})),a||t.sync(i)};this.channel.on(D,r),this.channel.on(Z,function(d){var s=d.storyId,i=d.newPhase,l=t.getState(s),g=l.isDebugging,f=l.forwardedException;if(t.setState(s,{renderPhase:i}),i==="playing"&&r({storyId:s,isDebugging:g}),i==="played"&&(t.setState(s,{isLocked:!1,isPlaying:!1,isDebugging:!1,forwardedException:void 0}),f))throw f}),this.channel.on(tt,function(){t.initialized?t.cleanup():t.initialized=!0});var n=function(s){var i=s.storyId,l=s.playUntil;t.getState(i).isDebugging||t.setState(i,function(f){var a=f.calls;return{calls:[],shadowCalls:a.map(function(c){return Object.assign({},c,{status:m.WAITING})}),isDebugging:!0}});var g=t.getLog(i);t.setState(i,function(f){var a,c=f.shadowCalls,_=c.findIndex(function(h){return h.id===g[0].callId});return{playUntil:l||((a=c.slice(0,_).filter(function(h){return h.interceptable}).slice(-1)[0])===null||a===void 0?void 0:a.id)}}),t.channel.emit(D,{storyId:i,isDebugging:!0})},u=function(s){var i,l=s.storyId,g=t.getState(l),f=g.isDebugging,a=t.getLog(l),c=f?a.findIndex(function(_){var h=_.status;return h===m.WAITING}):a.length;n({storyId:l,playUntil:(i=a[c-2])===null||i===void 0?void 0:i.callId})},o=function(s){var i=s.storyId,l=s.callId,g=t.getState(i),f=g.calls,a=g.shadowCalls,c=g.resolvers,_=f.find(function(I){var w=I.id;return w===l}),h=a.find(function(I){var w=I.id;return w===l});if(!_&&h&&Object.values(c).length>0){var p,b=(p=t.getLog(i).find(function(I){return I.status===m.WAITING}))===null||p===void 0?void 0:p.callId;h.id!==b&&t.setState(i,{playUntil:h.id}),Object.values(c).forEach(function(I){return I()})}else n({storyId:i,playUntil:l})},v=function(s){var i=s.storyId,l=t.getState(i),g=l.resolvers;if(Object.values(g).length>0)Object.values(g).forEach(function(c){return c()});else{var f,a=(f=t.getLog(i).find(function(c){return c.status===m.WAITING}))===null||f===void 0?void 0:f.callId;a?n({storyId:i,playUntil:a}):y({storyId:i})}},y=function(s){var i=s.storyId;t.setState(i,{playUntil:void 0,isDebugging:!1}),Object.values(t.getState(i).resolvers).forEach(function(l){return l()})};this.channel.on(O.START,n),this.channel.on(O.BACK,u),this.channel.on(O.GOTO,o),this.channel.on(O.NEXT,v),this.channel.on(O.END,y)}return mt(e,[{key:"getState",value:function(r){return this.state[r]||A()}},{key:"setState",value:function(r,n){var u=this.getState(r),o=typeof n=="function"?n(u):n;this.state=Object.assign({},this.state,N({},r,Object.assign({},u,o))),S.window.parent.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER_STATE__=this.state}},{key:"cleanup",value:function(){this.state=Object.entries(this.state).reduce(function(r,n){var u=M(n,2),o=u[0],v=u[1],y=L(v);return y&&(r[o]=Object.assign(A(),y)),r},{}),this.channel.emit(O.SYNC,{controlStates:x,logItems:[]}),S.window.parent.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER_STATE__=this.state}},{key:"getLog",value:function(r){var n=this.getState(r),u=n.calls,o=n.shadowCalls,v=E(o);u.forEach(function(d,s){v[s]=d});var y=new Set;return v.reduceRight(function(d,s){return s.args.forEach(function(i){i!=null&&i.__callId__&&y.add(i.__callId__)}),s.path.forEach(function(i){i.__callId__&&y.add(i.__callId__)}),s.interceptable&&!y.has(s.id)&&(d.unshift({callId:s.id,status:s.status}),y.add(s.id)),d},[])}},{key:"instrument",value:function(r,n){var u=this;if(!Tt(r))return r;var o=n.mutate,v=o===void 0?!1:o,y=n.path,d=y===void 0?[]:y;return Object.keys(r).reduce(function(s,i){var l=r[i];return typeof l!="function"?(s[i]=u.instrument(l,Object.assign({},n,{path:d.concat(i)})),s):typeof l.__originalFn__=="function"?(s[i]=l,s):(s[i]=function(){for(var g=arguments.length,f=new Array(g),a=0;a<g;a++)f[a]=arguments[a];return u.track(i,l,f,n)},s[i].__originalFn__=l,Object.defineProperty(s[i],"name",{value:i,writable:!1}),Object.keys(l).length>0&&Object.assign(s[i],u.instrument(Object.assign({},l),Object.assign({},n,{path:d.concat(i)}))),s)},v?r:Et(r))}},{key:"track",value:function(r,n,u,o){var v,y,d,s,i=(u==null||(v=u[0])===null||v===void 0?void 0:v.__storyId__)||((y=S.window.__STORYBOOK_PREVIEW__)===null||y===void 0||(d=y.urlStore)===null||d===void 0||(s=d.selection)===null||s===void 0?void 0:s.storyId),l=this.getState(i),g=l.cursor,f=l.parentId;this.setState(i,{cursor:g+1});var a="".concat(f||i," [").concat(g,"] ").concat(r),c=o.path,_=c===void 0?[]:c,h=o.intercept,p=h===void 0?!1:h,b=o.retain,I=b===void 0?!1:b,w=typeof p=="function"?p(r,_):p,C={id:a,parentId:f,storyId:i,cursor:g,path:_,method:r,args:u,interceptable:w,retain:I},W=(w?this.intercept:this.invoke).call(this,n,C,o);return this.instrument(W,Object.assign({},o,{mutate:!0,path:[{__callId__:C.id}]}))}},{key:"intercept",value:function(r,n,u){var o=this,v=this.getState(n.storyId),y=v.chainedCallIds,d=v.isDebugging,s=v.playUntil,i=y.has(n.id);return!d||i||s?(s===n.id&&this.setState(n.storyId,{playUntil:void 0}),this.invoke(r,n,u)):new Promise(function(l){o.setState(n.storyId,function(g){var f=g.resolvers;return{isLocked:!1,resolvers:Object.assign({},f,N({},n.id,l))}})}).then(function(){return o.setState(n.storyId,function(l){var g=l.resolvers,f=n.id;g[f];var a=dt(g,[f].map(yt));return{isLocked:!0,resolvers:a}}),o.invoke(r,n,u)})}},{key:"invoke",value:function(r,n,u){var o=this,v=this.getState(n.storyId),y=v.callRefsByResult,d=v.forwardedException,s=v.renderPhase,i=Object.assign({},n,{args:n.args.map(function(a){if(y.has(a))return y.get(a);if(a instanceof S.window.HTMLElement){var c=a.prefix,_=a.localName,h=a.id,p=a.classList,b=a.innerText,I=Array.from(p);return{__element__:{prefix:c,localName:_,id:h,classNames:I,innerText:b}}}return a})});n.path.forEach(function(a){a!=null&&a.__callId__&&o.setState(n.storyId,function(c){var _=c.chainedCallIds;return{chainedCallIds:new Set(Array.from(_).concat(a.__callId__))}})});var l=function(c){if(c instanceof Error){var _=c.name,h=c.message,p=c.stack,b={name:_,message:h,stack:p};if(o.update(Object.assign({},i,{status:m.ERROR,exception:b})),o.setState(n.storyId,function(I){return{callRefsByResult:new Map([].concat(E(Array.from(I.callRefsByResult.entries())),[[c,{__callId__:n.id,retain:n.retain}]]))}}),n.interceptable&&c!==U)throw et;return o.setState(n.storyId,{forwardedException:c}),c}throw c};try{if(d)throw this.setState(n.storyId,{forwardedException:void 0}),d;if(s==="played"&&!n.retain)throw U;var g=u.getArgs?u.getArgs(n,this.getState(n.storyId)):n.args,f=r.apply(void 0,E(g.map(function(a){return typeof a!="function"||Object.keys(a).length?a:function(){var c=o.getState(n.storyId),_=c.cursor,h=c.parentId;o.setState(n.storyId,{cursor:0,parentId:n.id});var p=function(){return o.setState(n.storyId,{cursor:_,parentId:h})},b=a.apply(void 0,arguments);return b instanceof Promise?b.then(p,p):p(),b}})));return f&&["object","function","symbol"].includes(T(f))&&this.setState(n.storyId,function(a){return{callRefsByResult:new Map([].concat(E(Array.from(a.callRefsByResult.entries())),[[f,{__callId__:n.id,retain:n.retain}]]))}}),this.update(Object.assign({},i,{status:f instanceof Promise?m.ACTIVE:m.DONE})),f instanceof Promise?f.then(function(a){return o.update(Object.assign({},i,{status:m.DONE})),a},l):f}catch(a){return l(a)}}},{key:"update",value:function(r){var n=this;clearTimeout(this.getState(r.storyId).syncTimeout),this.channel.emit(O.CALL,r),this.setState(r.storyId,function(u){var o=u.calls,v=o.concat(r).reduce(function(y,d){return Object.assign(y,N({},d.id,d))},{});return{calls:Object.values(v).sort(function(y,d){return y.id.localeCompare(d.id,void 0,{numeric:!0})}),syncTimeout:setTimeout(function(){return n.sync(r.storyId)},0)}})}},{key:"sync",value:function(r){var n=this.getState(r),u=n.isLocked,o=n.isPlaying,v=this.getLog(r),y=v.some(function(i){return i.status===m.ACTIVE});if(Y||u||y||v.length===0){this.channel.emit(O.SYNC,{controlStates:x,logItems:v});return}var d=v.some(function(i){return[m.DONE,m.ERROR].includes(i.status)}),s={debugger:!0,start:d,back:d,goto:!0,next:o,end:o};this.channel.emit(O.SYNC,{controlStates:s,logItems:v})}}]),e}();function Pt(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};try{if(S.window.parent===S.window)return e;S.window.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER__||(S.window.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER__=new Rt);var r=S.window.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER__;return r.instrument(e,t)}catch(n){return Q.warn(n),e}}export{Pt as i};
//# sourceMappingURL=instrumenter.fba118ce.js.map
